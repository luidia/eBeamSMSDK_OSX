//
//  BLESearchListController.m
//  PenTestOSX
//
//  Created by Luidia on 2019
//  Copyright © 2019년 Luidia. All rights reserved.
//

#import "BLESearchListController.h"

@interface BLESearchListController () <NSTableViewDelegate, NSTableViewDataSource>
{
    IBOutlet NSTableView *tableView;
}
@end

@implementation BLESearchListController
@synthesize deviceList;
@synthesize delegate;

- (id)initWithWindow:(NSWindow *)window
{
    self = [super initWithWindow:window];
    if (self) {
        self.delegate = nil;
        self.deviceList = [[[NSMutableArray alloc] init] autorelease];
    }
    return self;
}

- (BOOL)windowShouldClose:(NSWindow *)sender {
    if (self.delegate) {
        if ([self.delegate respondsToSelector:@selector(closeBLESearchListViewController)]) {
            [self.delegate closeBLESearchListViewController];
        }
    }
    return YES;
}

- (void)windowDidLoad {
    [super windowDidLoad];
    
    tableView.delegate = self;
    tableView.dataSource = self;
}

-(void) refresh {
    [tableView reloadData];
}
- (IBAction)selectClicked:(id)sender {
    int idx = (int)[tableView selectedRow];
    if (idx == -1)
        return;
    
    CBPeripheral* peripheral = [[self.deviceList objectAtIndex:idx] objectForKey:@"peripheral"];
    if (self.delegate) {
        if ([self.delegate respondsToSelector:@selector(selectBLEDevice:)]) {
            [self.delegate selectBLEDevice:peripheral];
        }
    }
}
-(NSInteger) numberOfRowsInTableView:(NSTableView *)tableView {
    return self.deviceList.count;
}
- (id)tableView:(NSTableView *)tableView objectValueForTableColumn:(NSTableColumn *)tableColumn row:(NSInteger)row {
    NSDictionary* advertisementData = [[self.deviceList objectAtIndex:row] objectForKey:@"advertisementData"];
    NSString *localName = [advertisementData objectForKey:CBAdvertisementDataLocalNameKey];
    if (localName == nil || [localName isEqualToString:@""]) {
        CBPeripheral* peripheral = [[self.deviceList objectAtIndex:row] objectForKey:@"peripheral"];
        localName = peripheral.name;
    }
    
    return localName;
}
@end
