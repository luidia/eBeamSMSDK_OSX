//
//  VoiceChangeViewController.m
//  PenTestOSX
//
//  Created by Luidia on 2019
//  Copyright © 2019년 Luidia. All rights reserved.
//

#import "VoiceChangeViewController.h"
#import "PNFPenLibOSXExtension.h"

@interface VoiceChangeViewController () <NSTableViewDelegate, NSTableViewDataSource>
{
    IBOutlet NSTableView *tableView;
}
@end

@implementation VoiceChangeViewController
@synthesize penController;
@synthesize delegate;
@synthesize languageList;

- (void)dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self name:@"PNF_MSG" object:nil];
    [[NSNotificationCenter defaultCenter] removeObserver:self name:@"PNF_MSG" object:nil];
    
    [super dealloc];
}

- (id)initWithWindow:(NSWindow *)window
{
    self = [super initWithWindow:window];
    if (self) {
        self.delegate = nil;
        self.languageList = [[[NSMutableArray alloc] init] autorelease];
    }
    return self;
}

- (BOOL)windowShouldClose:(NSWindow *)sender {
    if (self.delegate) {
        if ([self.delegate respondsToSelector:@selector(closeVoiceChangeViewController)]) {
            [self.delegate closeVoiceChangeViewController];
        }
    }
    return YES;
}

- (void)windowDidLoad {
    [super windowDidLoad];
    
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(PenCallBackFunc:) name:@"PNF_MSG" object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(FreeLogMsg:) name:@"PNF_LOG_MSG" object:nil];
    
    tableView.delegate = self;
    tableView.dataSource = self;
    
    [self.languageList addObject:@"English"];
    [self.languageList addObject:@"한국어"];
    [self.languageList addObject:@"Español"];
    [self.languageList addObject:@"Deutsch"];
    [self.languageList addObject:@"Français"];
    [self.languageList addObject:@"Italiano"];
    [self.languageList addObject:@"日本語"];
    [self.languageList addObject:@"Português"];
    [self.languageList addObject:@"Русский"];
    [self.languageList addObject:@"简体中文"];
    [self.languageList addObject:@"العربية"];
    
    [tableView reloadData];
    
    if(penController.isBLEConnect){
        NSIndexSet *indexSet = [NSIndexSet indexSetWithIndex:penController.deviceLanguage];
        [tableView selectRowIndexes:indexSet byExtendingSelection:NO];
    }
}

-(void) PenCallBackFunc:(NSNotification *)call {
    NSString * szS = (NSString *) [call object];
    
    if ([szS isEqualToString:@"SetDeviceLanguage_OK"]) {
        NSAlert* alert = [[[NSAlert alloc] init] autorelease];
        [alert addButtonWithTitle:@"OK"];
        [alert setMessageText:@"Change voice Complete."];
        [alert setAlertStyle:NSInformationalAlertStyle];
        [alert beginSheetModalForWindow:self.window
                          modalDelegate:self
                         didEndSelector:@selector(changeVoiceSuccess)
                            contextInfo:NULL];
    }
    else if ([szS isEqualToString:@"SetDeviceLanguage_FAIL"] || [szS isEqualToString:@"DI_SEND_ERR"]) {
        NSAlert* alert = [[[NSAlert alloc] init] autorelease];
        [alert addButtonWithTitle:@"OK"];
        [alert setMessageText:@"Change voice fail."];
        [alert setAlertStyle:NSInformationalAlertStyle];
        [alert beginSheetModalForWindow:self.window
                          modalDelegate:self
                         didEndSelector:@selector(changeVoiceFail)
                            contextInfo:NULL];
    }
}

- (void) FreeLogMsg:(NSNotification *) note {
    NSString * szS = (NSString *) [note object];
    if ([szS compare:@"FAIL_LISTENING"] == 0 ) {
        
    }
    else if ([szS isEqualToString:@"CONNECTED"]) {
        
    }
    else if ([szS isEqualToString:@"INVALID_PROTOCOL"]) {
        
    }
    else if ([szS isEqualToString:@"SESSION_CLOSED"]) {
        if (self.delegate) {
            if ([self.delegate respondsToSelector:@selector(closeVoiceChangeViewController)]) {
                [self.delegate closeVoiceChangeViewController];
            }
        }
    }
    else if ([szS isEqualToString:@"PEN_RMD_ERROR"]) {
        
    }
    else if ([szS isEqualToString:@"FIRST_DATA_RECV"]) {
    }
}

- (IBAction)selectClicked:(id)sender {
    int idx = (int)[tableView selectedRow];
    
    if (idx == -1)
        return;
    
    [penController setDeviceLanguage:(enum DEVICE_LANGUAGE_CODE)idx];
}
-(NSInteger) numberOfRowsInTableView:(NSTableView *)tableView {
    return self.languageList.count;
}
- (id)tableView:(NSTableView *)tableView objectValueForTableColumn:(NSTableColumn *)tableColumn row:(NSInteger)row {
    NSString* language = [self.languageList objectAtIndex:row];
    
    return language;
}

-(void)changeVoiceSuccess {
    if (self.delegate) {
        if ([self.delegate respondsToSelector:@selector(successVoiceChangeViewController)]) {
            [self.delegate successVoiceChangeViewController];
        }
    }
}

-(void)changeVoiceFail {
    if (self.delegate) {
        if ([self.delegate respondsToSelector:@selector(closeVoiceChangeViewController)]) {
            [self.delegate closeVoiceChangeViewController];
        }
    }
}

@end
